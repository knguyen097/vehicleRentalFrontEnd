<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Rentals — AutoRentals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    main {
      max-width: 960px;
      margin: 2rem auto;
      padding: 1.5rem;
      background: var(--panel);
      border-radius: 1.2rem;
      border: 0.08rem solid var(--border);
    }
    h1 { margin-top: 0; }

    .rentals-list {
      display: grid;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .rental-card {
      padding: 1rem;
      border-radius: 0.9rem;
      background: var(--card);
      border: 0.08rem solid var(--border);
      display: grid;
      gap: 0.4rem;
    }

    .badge-current {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: var(--step--1);
      background: linear-gradient(180deg, #164e63, #0f172a);
      border: 0.08rem solid var(--accent-2);
    }

    .cancel-btn {
      margin-top: 0.6rem;
      padding: 0.5rem 0.8rem;
      background: linear-gradient(180deg, #4a0f0f, #2d0a0a);
      border: 1px solid #8b1a1a;
      color: #ffb9b9;
      border-radius: 0.6rem;
      cursor: pointer;
      transition: background 0.15s ease, border 0.15s ease;
    }

    .cancel-btn:hover {
      background: linear-gradient(180deg, #5c0f0f, #3a0a0a);
      border-color: #ff4d4d;
    }
  </style>
</head>

<body>
  <main>
    <h1>My Rentals</h1>
    <p id="status" class="muted">Loading your rentals…</p>
    <div id="rentals" class="rentals-list"></div>

    <p class="muted" style="margin-top:1rem;">
      <a href="./index.html">← Back to vehicles</a>
    </p>
  </main>

  <script>
    const API = "http://localhost:8000";
    const STORAGE_KEY = 'currentUser';

    function getCurrentUser() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        try { return JSON.parse(raw); } catch { return null; }
    }

    function isCurrentRental(rental) {
        const today = new Date().toISOString().slice(0, 10);
        return rental.start_date <= today && rental.end_date >= today;
    }

    /* ==========================================================
       LOAD RENTALS
    ========================================================== */
    async function loadRentals() {
        const statusEl = document.getElementById('status');
        const listEl = document.getElementById('rentals');
        const user = getCurrentUser();

        if (!user) {
            statusEl.textContent = 'Please sign in to view your rentals.';
            return;
        }

        try {
            const res = await fetch(`${API}/users/${user.user_id}/rentals`);

            if (!res.ok) {
                statusEl.textContent = 'Failed to load rentals.';
                return;
            }

            const data = await res.json();

            if (!data.length) {
                statusEl.textContent = 'You have no rentals yet.';
                return;
            }

            const current = data.filter(isCurrentRental);
            const past = data.filter(r => !isCurrentRental(r));

            statusEl.textContent = '';
            listEl.innerHTML = '';

            /* ------------------------------------------------------
               CURRENT RENTALS
            ------------------------------------------------------ */
            if (current.length) {
                const header = document.createElement("h2");
                header.textContent = "Current Rentals";
                listEl.appendChild(header);

                current.forEach(r => {
                    const card = document.createElement("div");
                    card.className = "rental-card";

                    card.innerHTML = `
                        <div><span class="badge-current">Current</span></div>
                        <div>Vehicle: <strong>${r.make} ${r.model}</strong> <span class="muted">(#${r.vehicle_id})</span></div>
                        <div>From: <strong>${r.start_date}</strong> to <strong>${r.end_date}</strong></div>
                        <div>Total days: <strong>${r.total_days}</strong></div>
                        <div>Total price: <strong>$${Number(r.total_price).toFixed(2)}</strong></div>

                        <button class="cancel-btn" data-id="${r.rental_id}">
                            Cancel Rental
                        </button>
                    `;

                    listEl.appendChild(card);
                });
            }

            /* ------------------------------------------------------
               PAST RENTALS
            ------------------------------------------------------ */
            if (past.length) {
                const header = document.createElement("h2");
                header.textContent = "Past Rentals";
                header.style.marginTop = "2rem";
                listEl.appendChild(header);

                past.forEach(r => {
                    const card = document.createElement("div");
                    card.className = "rental-card";

                    card.innerHTML = `
                        <div>Vehicle: <strong>${r.make} ${r.model}</strong> <span class="muted">(#${r.vehicle_id})</span></div>
                        <div>From: <strong>${r.start_date}</strong> to <strong>${r.end_date}</strong></div>
                        <div>Total days: <strong>${r.total_days}</strong></div>
                        <div>Total price: <strong>$${Number(r.total_price).toFixed(2)}</strong></div>
                    `;

                    listEl.appendChild(card);
                });
            }

        } catch (e) {
            console.error(e);
            statusEl.textContent = 'Network error loading rentals.';
        }
    }

    loadRentals();


    /* ==========================================================
       CANCEL RENTAL HANDLER
    ========================================================== */
    document.addEventListener("click", async (e) => {
        const btn = e.target.closest(".cancel-btn");
        if (!btn) return;

        const rentalId = btn.dataset.id;

        if (!confirm("Are you sure you want to cancel this rental?")) return;

        try {
            const res = await fetch(`${API}/rentals/${rentalId}`, {
                method: "DELETE"
            });

            if (res.status === 204) {
                alert("Rental canceled.");
                loadRentals();  
            } else {
                alert("Failed to cancel rental.");
            }

        } catch (err) {
            alert("Network error canceling rental.");
        }
    });
  </script>
</body>
</html>
